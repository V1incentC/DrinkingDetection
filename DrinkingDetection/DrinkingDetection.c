#include <stdbool.h>
#include <stdint.h>

#ifdef __cplusplus
extern "C" {
#endif
	
#include "nrf_delay.h"
#include "nrf_gpio.h"
#include "boards.h"
#include "nrf_log.h"
#include "nrf_log_ctrl.h"
#include "nrf_log_default_backends.h"
#include "imu_api.h"
#include "imu_low_level.h"
#include "lsm6dsl/lsm6dsl_reg.h"
#include "bsp.h"
#include "calculation_features.h"
#include "machine_learning_features.h"
#include  "arm_math.h"

#ifdef __cplusplus
}
#endif
#define BUTTON NRF_GPIO_PIN_MAP(0,24)
const uint8_t leds_list[LEDS_NUMBER] = LEDS_LIST;

float acc_x_buff[256] = { -0.963251, -1.251598, -0.542290, -0.516792, -0.536922, -0.448472, -0.427244, -0.467199, -0.479277, -0.468724, -0.458842, -0.452925, -0.444507, -0.431392, -0.427732, -0.422791, -0.416508, -0.415227, -0.416203, -0.411933, -0.409066, -0.406199, -0.402417, -0.403698, -0.405528, -0.405894, -0.401807, -0.393816, -0.386435, -0.397476, -0.397598, -0.378139, -0.379969, -0.388753, -0.398879, -0.386801, -0.393084, -0.378993, -0.391376, -0.414983, -0.440908, -0.428342, -0.394243, -0.441213, -0.468419, -0.438651, -0.438956, -0.433161, -0.427671, -0.401624, -0.398757, -0.358131, -0.397659, -0.398330, -0.403515, -0.402356, -0.393145, -0.369416, -0.377590, -0.385215, -0.388875, -0.376797, -0.399550, -0.406382, -0.402783, -0.386069, -0.398940, -0.420168, -0.430721, -0.414068, -0.414068, -0.404247, -0.314699, -0.315553, -0.316468, -0.316529, -0.316102, -0.318115, -0.318664, -0.318420, -0.312137, -0.308782, -0.302377, -0.292983, -0.282979, -0.272426, -0.266204, -0.265777, -0.265777, -0.269132, -0.272243, -0.276208, -0.278099, -0.280173, -0.282247, -0.284443, -0.287798, -0.283406, -0.281271, -0.276940, -0.273097, -0.267607, -0.262483, -0.262178, -0.261263, -0.266997, -0.271694, -0.276269, -0.272121, -0.271267, -0.271450, -0.277245, -0.283833, -0.291275, -0.293715, -0.298290, -0.298412, -0.296033, -0.290177, -0.288408, -0.285663, -0.281698, -0.275598, -0.273219, -0.269132, -0.266265, -0.265045, -0.268095, -0.269559, -0.275171, -0.280478, -0.286883, -0.293837, -0.299571, -0.303353, -0.305854, -0.303414, -0.302255, -0.297985, -0.294325, -0.294752, -0.292007, -0.288530, -0.287493, -0.288408, -0.289628, -0.292556, -0.293837, -0.294447, -0.295484, -0.295423, -0.294508, -0.294264, -0.297070, -0.293959, -0.292678, -0.288408, -0.289506, -0.290665, -0.290421, -0.294874, -0.295484, -0.295789, -0.296277, -0.298107, -0.299144, -0.299632, -0.297741, -0.296521, -0.294447, -0.292068, -0.289445, -0.290543, -0.292373, -0.293898, -0.296277, -0.297619, -0.296643, -0.296338, -0.294813, -0.295301, -0.296399, -0.298473, -0.300791, -0.300913, -0.303109, -0.303353, -0.303536, -0.299937, -0.294447, -0.290299, -0.286883, -0.273158, -0.277611, -0.286029, -0.292190, -0.298229, -0.301035, -0.303353, -0.302560, -0.300852, -0.298900, -0.293715, -0.291580, -0.284687, -0.277855, -0.275415, -0.270291, -0.269498, -0.271511, -0.275232, -0.277794, -0.276025, -0.276025, -0.278282, -0.281393, -0.286395, -0.290543, -0.291214, -0.290177, -0.287676, -0.285358, -0.285541, -0.285053, -0.285846, -0.284931, -0.286578, -0.287493, -0.289262, -0.288957, -0.289018, -0.289628, -0.288225, -0.288408, -0.286700, -0.286212, -0.287920, -0.287920, -0.289018, -0.288652, -0.289140, -0.288957, -0.290055, -0.290848, -0.289628, -0.292678, -0.293105, -0.294630, -0.294752, -0.297497, -0.292800, -0.287127, -0.282796, -0.281027, -0.282186, -0.285663 };

float acc_x_buff1[256] = { -0.963251, -1.251598, -0.542290, -0.516792, -0.536922, -0.448472, -0.427244, -0.467199, -0.479277, -0.468724, -0.458842, -0.452925, -0.444507, -0.431392, -0.427732, -0.422791, -0.416508, -0.415227, -0.416203, -0.411933, -0.409066, -0.406199, -0.402417, -0.403698, -0.405528, -0.405894, -0.401807, -0.393816, -0.386435, -0.397476, -0.397598, -0.378139, -0.379969, -0.388753, -0.398879, -0.386801, -0.393084, -0.378993, -0.391376, -0.414983, -0.440908, -0.428342, -0.394243, -0.441213, -0.468419, -0.438651, -0.438956, -0.433161, -0.427671, -0.401624, -0.398757, -0.358131, -0.397659, -0.398330, -0.403515, -0.402356, -0.393145, -0.369416, -0.377590, -0.385215, -0.388875, -0.376797, -0.399550, -0.406382, -0.402783, -0.386069, -0.398940, -0.420168, -0.430721, -0.414068, -0.414068, -0.404247, -0.314699, -0.315553, -0.316468, -0.316529, -0.316102, -0.318115, -0.318664, -0.318420, -0.312137, -0.308782, -0.302377, -0.292983, -0.282979, -0.272426, -0.266204, -0.265777, -0.265777, -0.269132, -0.272243, -0.276208, -0.278099, -0.280173, -0.282247, -0.284443, -0.287798, -0.283406, -0.281271, -0.276940, -0.273097, -0.267607, -0.262483, -0.262178, -0.261263, -0.266997, -0.271694, -0.276269, -0.272121, -0.271267, -0.271450, -0.277245, -0.283833, -0.291275, -0.293715, -0.298290, -0.298412, -0.296033, -0.290177, -0.288408, -0.285663, -0.281698, -0.275598, -0.273219, -0.269132, -0.266265, -0.265045, -0.268095, -0.269559, -0.275171, -0.280478, -0.286883, -0.293837, -0.299571, -0.303353, -0.305854, -0.303414, -0.302255, -0.297985, -0.294325, -0.294752, -0.292007, -0.288530, -0.287493, -0.288408, -0.289628, -0.292556, -0.293837, -0.294447, -0.295484, -0.295423, -0.294508, -0.294264, -0.297070, -0.293959, -0.292678, -0.288408, -0.289506, -0.290665, -0.290421, -0.294874, -0.295484, -0.295789, -0.296277, -0.298107, -0.299144, -0.299632, -0.297741, -0.296521, -0.294447, -0.292068, -0.289445, -0.290543, -0.292373, -0.293898, -0.296277, -0.297619, -0.296643, -0.296338, -0.294813, -0.295301, -0.296399, -0.298473, -0.300791, -0.300913, -0.303109, -0.303353, -0.303536, -0.299937, -0.294447, -0.290299, -0.286883, -0.273158, -0.277611, -0.286029, -0.292190, -0.298229, -0.301035, -0.303353, -0.302560, -0.300852, -0.298900, -0.293715, -0.291580, -0.284687, -0.277855, -0.275415, -0.270291, -0.269498, -0.271511, -0.275232, -0.277794, -0.276025, -0.276025, -0.278282, -0.281393, -0.286395, -0.290543, -0.291214, -0.290177, -0.287676, -0.285358, -0.285541, -0.285053, -0.285846, -0.284931, -0.286578, -0.287493, -0.289262, -0.288957, -0.289018, -0.289628, -0.288225, -0.288408, -0.286700, -0.286212, -0.287920, -0.287920, -0.289018, -0.288652, -0.289140, -0.288957, -0.290055, -0.290848, -0.289628, -0.292678, -0.293105, -0.294630, -0.294752, -0.297497, -0.292800, -0.287127, -0.282796, -0.281027, -0.282186, -0.285663 };


int main(void)
{

    APP_ERROR_CHECK(NRF_LOG_INIT(NULL));
    NRF_LOG_DEFAULT_BACKENDS_INIT();
	
    NRF_LOG_INFO("This is a log data from nrf");
    nrf_gpio_cfg_input(BUTTON, NRF_GPIO_PIN_PULLUP);
    // imu_init(&lsm6dsl_dev_ctx_t);
    char buff[100];
    
    float features[294], features1[294], Pxx[129], Pxx1[129], Bin[10], Bin1[10];
    
    mlf_fill_raw_eating_features(features1, acc_x_buff1, 256);
    mlf_fill_frequency_eating_features(&features1[13], acc_x_buff1, 256);
    
    CF_fill_raw_features(features, acc_x_buff, 256);
    CF_fill_frequency_features(&features[13], acc_x_buff, 256);

    
    for (int i = 0; i < 49; ++i)
    {
        sprintf(buff, "%d mlf= %f  CF = %f \n", i, features1[i], features[i]);
        NRF_LOG_INFO("%s", buff);
    }



	for (;;)
	{
    	if (nrf_gpio_pin_read(BUTTON) == 0)
    	{
        	NRF_LOG_INFO("Button");
        	imu_fifo_mode(&lsm6dsl_dev_ctx_t, IMU_FIFO_SIZE);
        	while (nrf_gpio_pin_read(BUTTON) == 0) ;
        	
    	}
    	imu_handle_fifo_transfer_done();
                             
	}
}
