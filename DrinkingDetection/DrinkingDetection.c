#include <stdbool.h>
#include <stdint.h>

#ifdef __cplusplus
extern "C" {
#endif
	
#include "nrf_delay.h"
#include "nrf_gpio.h"
#include "boards.h"
#include "nrf_log.h"
#include "nrf_log_ctrl.h"
#include "nrf_log_default_backends.h"
#include "imu_api.h"
#include "imu_low_level.h"
#include "lsm6dsl/lsm6dsl_reg.h"
#include "bsp.h"
#include "calculation_features.h"
#include "machine_learning_features.h"
#include  "arm_math.h"

#ifdef __cplusplus
}
#endif
#define BUTTON NRF_GPIO_PIN_MAP(0,24)
const uint8_t leds_list[LEDS_NUMBER] = LEDS_LIST;

float acc_x_buff[256] = {0.2265875739424524,0.2001829896184586,0.1931089198305316,0.1889323563233565,0.1477656748854418,0.1092480354835677,
                           0.0836083140087121,0.0836083140087121,0.0836083140087121,0.0782146307014683,0.0782146307014683,
                           0.0695347650548972,0.0396209802908792,0.0199366852701455,-0.0197929890593106,-0.057247821297572,
                           -0.0710737109009796,-0.0781093025092923,-0.0789045848417563,-0.0838720688246928,-0.115625421524607,
                           -0.1516857301327949,-0.1900015079088833,-0.2373817311899753,-0.2803481466135202,-0.2803481466135202,
                           -0.2803481466135202,-0.2806042561780347,-0.2806042561780347,-0.2806042561780347,-0.2806042561780347,
                           -0.2806042561780347,-0.2588659206235352,-0.2288694686400491,-0.2288694686400491,-0.2288694686400491,
                           -0.2363799088393469,-0.2781547767219283,-0.3006565645456333,-0.3006565645456333,-0.3006565645456333,
                           -0.2963595328480388,-0.2740321382109346,-0.2623503101736746,-0.2490206045851909,-0.2214562016381495,
                           -0.205137400130159,-0.198594947187907,-0.1940757902090464,-0.1940757902090464,-0.1718048903993478,
                           -0.1451675336048864,-0.1132241277929379,-0.1132241277929379,-0.1132241277929379,-0.1222192661891801,
                           -0.1613885719390867,-0.1613885719390867,-0.1613885719390867,-0.1198139868042268,-0.100560919505054,
                           -0.0515640039965759,-0.0044830424781983,0.0135188369111918,0.0259893609930877,0.0259893609930877,
                           0.0259893609930877,0.0144864874397543,0.0013777858921907,0.0013777858921907,0.0013777858921907,
                           0.0013777858921907,0.0013777858921907,-0.0197869974200819,-0.0344190407089573,-0.0386388988568892,
                           -0.0386388988568892,-0.0386388988568892,-0.0274247150452846,-0.0179174816371211,0.000470684816482,
                           0.0116241619273179,0.0193783330315129,0.0245197003576895,0.0306064443766744,0.0476884545737712,
                           0.0652926581505873,0.0844666233619248,0.0991881345859918,0.1060658399136527,0.1236515400797008,
                           0.1413426612519054,0.1413426612519054,0.1413426612519054,0.1209628593591122,0.118279338549171,
                           0.118279338549171,0.118279338549171,0.1275763561063829,0.1336305086610266,0.1512573009866207,
                           0.17513837143398,0.1780876216006566,0.1784886741407947,0.1829733364014582,0.1803730468985477,
                           0.1784886741407947,0.1784886741407947,0.1655614274539578,0.1559127097147544,0.1559127097147544,
                           0.1559127097147544,0.1551904324191745,0.1551904324191745,0.1543150839391335,0.1303347892080966,
                           0.0957512424363558,0.0558234921496242,0.0164834301412212,-0.0105077467646649,-0.0379256585889151,
                           -0.0714544246624477,-0.1090947845376213,-0.1339295901873455,-0.1397831706918511,-0.1456005972162094,
                           -0.1591019585027149,-0.1717311648744088,-0.1831029948395896,-0.1831029948395896,-0.1831029948395896,
                           -0.1810844458808846,-0.1801749650149554,-0.1801749650149554,-0.1801749650149554,-0.1978131485498726,
                           -0.2187759298963542,-0.2191387780621736,-0.2191387780621736,-0.2191387780621736,-0.2131862482307586,
                           -0.2113039625413708,-0.2113039625413708,-0.2113039625413708,-0.2158582396123066,-0.2158582396123066,
                           -0.2158582396123066,-0.1948797325076301,-0.1608893404389255,-0.129385545007449,-0.129385545007449,
                           -0.129385545007449,-0.1302312093929764,-0.1759499912632311,-0.2113876361333033,-0.2113876361333033,
                           -0.2113876361333033,-0.1729881466863162,-0.1275043512654649,-0.1201058166571927,-0.1069001007887282,
                           -0.092693993594751,-0.0902274196430244,-0.0262358533191488,-0.0262358533191488,-0.0262358533191488,
                           -0.0376774728788667,-0.059286240642637,-0.0660490169657194,-0.0673597593066766,-0.0736028600169179,
                           -0.0753067844422659,-0.0753067844422659,-0.0871064177728739,-0.090206179003608,-0.090206179003608,
                           -0.090206179003608,-0.090206179003608,-0.0661234557424693,-0.0597185166303747,-0.0597185166303747,
                           -0.0597185166303747,-0.0695528438055956,-0.0708976428748807,-0.0903629608314836,-0.1005803392934862,
                           -0.1005803392934862,-0.1005803392934862,-0.0894560186725732,-0.0850462190408692,-0.0850462190408692,
                           -0.0850462190408692,-0.1021691238714908,-0.1258536096122784,-0.1571774842931159,-0.1571774842931159,
                           -0.1571774842931159,-0.1256164218555086,-0.0702235149176841,-0.0255118847966207,0.0157394409196312,
                           0.0607428988014349,0.0607428988014349,0.0607428988014349,-2.210666903520626e-05,-0.0570882792306289,
                           -0.0618293964157766,-0.0618293964157766,-0.0618293964157766,-0.0289049132659615,-0.0289049132659615,
                           -0.0289049132659615,-0.0400630600005918,-0.0408206870526956,-0.0411091128150856,-0.0494346812335847,
                           -0.0641908583080579,-0.0874472404337963,-0.1107783365541207,-0.1310019097749595,-0.1496367983081967,
                           -0.1676074948105863,-0.1782240820286169,-0.186160079527822,-0.186160079527822,-0.186160079527822,
                           -0.1856149704646332,-0.1856149704646332,-0.1856149704646332,-0.2085090543458671,-0.2238776796344794,
                           -0.22616500509684,-0.2312354456578634,-0.246032227953574,-0.2676210647663099,-0.2848529827165787,
                           -0.2901940473546444,-0.2911026793623937,-0.3045359199367508,-0.3279600683828855,-0.3503743454835745,
                           -0.3503743454835745,-0.3503743454835745,-0.3434127738229055,-0.3154307174210311,-0.3100788536366374,
                           -0.3100788536366374,-0.3100788536366374,-0.3330567637697989,-0.3417238439938473,-0.3417238439938473,
                           -0.3417238439938473,-0.31910879083562,-0.2979043698006537,-0.2823834241865737,-0.2823834241865737};
float acc_x_buff1[256] = {0.2265875739424524,0.2001829896184586,0.1931089198305316,0.1889323563233565,0.1477656748854418,0.1092480354835677,
                           0.0836083140087121,0.0836083140087121,0.0836083140087121,0.0782146307014683,0.0782146307014683,
                           0.0695347650548972,0.0396209802908792,0.0199366852701455,-0.0197929890593106,-0.057247821297572,
                           -0.0710737109009796,-0.0781093025092923,-0.0789045848417563,-0.0838720688246928,-0.115625421524607,
                           -0.1516857301327949,-0.1900015079088833,-0.2373817311899753,-0.2803481466135202,-0.2803481466135202,
                           -0.2803481466135202,-0.2806042561780347,-0.2806042561780347,-0.2806042561780347,-0.2806042561780347,
                           -0.2806042561780347,-0.2588659206235352,-0.2288694686400491,-0.2288694686400491,-0.2288694686400491,
                           -0.2363799088393469,-0.2781547767219283,-0.3006565645456333,-0.3006565645456333,-0.3006565645456333,
                           -0.2963595328480388,-0.2740321382109346,-0.2623503101736746,-0.2490206045851909,-0.2214562016381495,
                           -0.205137400130159,-0.198594947187907,-0.1940757902090464,-0.1940757902090464,-0.1718048903993478,
                           -0.1451675336048864,-0.1132241277929379,-0.1132241277929379,-0.1132241277929379,-0.1222192661891801,
                           -0.1613885719390867,-0.1613885719390867,-0.1613885719390867,-0.1198139868042268,-0.100560919505054,
                           -0.0515640039965759,-0.0044830424781983,0.0135188369111918,0.0259893609930877,0.0259893609930877,
                           0.0259893609930877,0.0144864874397543,0.0013777858921907,0.0013777858921907,0.0013777858921907,
                           0.0013777858921907,0.0013777858921907,-0.0197869974200819,-0.0344190407089573,-0.0386388988568892,
                           -0.0386388988568892,-0.0386388988568892,-0.0274247150452846,-0.0179174816371211,0.000470684816482,
                           0.0116241619273179,0.0193783330315129,0.0245197003576895,0.0306064443766744,0.0476884545737712,
                           0.0652926581505873,0.0844666233619248,0.0991881345859918,0.1060658399136527,0.1236515400797008,
                           0.1413426612519054,0.1413426612519054,0.1413426612519054,0.1209628593591122,0.118279338549171,
                           0.118279338549171,0.118279338549171,0.1275763561063829,0.1336305086610266,0.1512573009866207,
                           0.17513837143398,0.1780876216006566,0.1784886741407947,0.1829733364014582,0.1803730468985477,
                           0.1784886741407947,0.1784886741407947,0.1655614274539578,0.1559127097147544,0.1559127097147544,
                           0.1559127097147544,0.1551904324191745,0.1551904324191745,0.1543150839391335,0.1303347892080966,
                           0.0957512424363558,0.0558234921496242,0.0164834301412212,-0.0105077467646649,-0.0379256585889151,
                           -0.0714544246624477,-0.1090947845376213,-0.1339295901873455,-0.1397831706918511,-0.1456005972162094,
                           -0.1591019585027149,-0.1717311648744088,-0.1831029948395896,-0.1831029948395896,-0.1831029948395896,
                           -0.1810844458808846,-0.1801749650149554,-0.1801749650149554,-0.1801749650149554,-0.1978131485498726,
                           -0.2187759298963542,-0.2191387780621736,-0.2191387780621736,-0.2191387780621736,-0.2131862482307586,
                           -0.2113039625413708,-0.2113039625413708,-0.2113039625413708,-0.2158582396123066,-0.2158582396123066,
                           -0.2158582396123066,-0.1948797325076301,-0.1608893404389255,-0.129385545007449,-0.129385545007449,
                           -0.129385545007449,-0.1302312093929764,-0.1759499912632311,-0.2113876361333033,-0.2113876361333033,
                           -0.2113876361333033,-0.1729881466863162,-0.1275043512654649,-0.1201058166571927,-0.1069001007887282,
                           -0.092693993594751,-0.0902274196430244,-0.0262358533191488,-0.0262358533191488,-0.0262358533191488,
                           -0.0376774728788667,-0.059286240642637,-0.0660490169657194,-0.0673597593066766,-0.0736028600169179,
                           -0.0753067844422659,-0.0753067844422659,-0.0871064177728739,-0.090206179003608,-0.090206179003608,
                           -0.090206179003608,-0.090206179003608,-0.0661234557424693,-0.0597185166303747,-0.0597185166303747,
                           -0.0597185166303747,-0.0695528438055956,-0.0708976428748807,-0.0903629608314836,-0.1005803392934862,
                           -0.1005803392934862,-0.1005803392934862,-0.0894560186725732,-0.0850462190408692,-0.0850462190408692,
                           -0.0850462190408692,-0.1021691238714908,-0.1258536096122784,-0.1571774842931159,-0.1571774842931159,
                           -0.1571774842931159,-0.1256164218555086,-0.0702235149176841,-0.0255118847966207,0.0157394409196312,
                           0.0607428988014349,0.0607428988014349,0.0607428988014349,-2.210666903520626e-05,-0.0570882792306289,
                           -0.0618293964157766,-0.0618293964157766,-0.0618293964157766,-0.0289049132659615,-0.0289049132659615,
                           -0.0289049132659615,-0.0400630600005918,-0.0408206870526956,-0.0411091128150856,-0.0494346812335847,
                           -0.0641908583080579,-0.0874472404337963,-0.1107783365541207,-0.1310019097749595,-0.1496367983081967,
                           -0.1676074948105863,-0.1782240820286169,-0.186160079527822,-0.186160079527822,-0.186160079527822,
                           -0.1856149704646332,-0.1856149704646332,-0.1856149704646332,-0.2085090543458671,-0.2238776796344794,
                           -0.22616500509684,-0.2312354456578634,-0.246032227953574,-0.2676210647663099,-0.2848529827165787,
                           -0.2901940473546444,-0.2911026793623937,-0.3045359199367508,-0.3279600683828855,-0.3503743454835745,
                           -0.3503743454835745,-0.3503743454835745,-0.3434127738229055,-0.3154307174210311,-0.3100788536366374,
                           -0.3100788536366374,-0.3100788536366374,-0.3330567637697989,-0.3417238439938473,-0.3417238439938473,
                           -0.3417238439938473,-0.31910879083562,-0.2979043698006537,-0.2823834241865737,-0.2823834241865737};


int main(void)
{

	APP_ERROR_CHECK(NRF_LOG_INIT(NULL));
	NRF_LOG_DEFAULT_BACKENDS_INIT();
	
	NRF_LOG_INFO("This is a log data from nrf");
    nrf_gpio_cfg_input(BUTTON, NRF_GPIO_PIN_PULLUP);
    imu_init(&lsm6dsl_dev_ctx_t);
    char buff[100];
    
    float data_out1[129], data_out2[129], input_copy[256];
    
    
    
    CF_welch_method(acc_x_buff1, 256, data_out1, 129);
    mlf_welch_method(acc_x_buff, 256, 256, 256, 256, mlf_window, data_out2, 129);
    
    
    for (int i = 0; i < 129; ++i)
    {
        sprintf(buff, "mlf= %f  CF = %f \n", data_out2[i], data_out1[i]);
        NRF_LOG_INFO("%s", buff);
    }



	for (;;)
	{
    	if (nrf_gpio_pin_read(BUTTON) == 0)
    	{
        	NRF_LOG_INFO("Button");
        	imu_fifo_mode(&lsm6dsl_dev_ctx_t, IMU_FIFO_SIZE);
        	while (nrf_gpio_pin_read(BUTTON) == 0) ;
        	
    	}
    	imu_handle_fifo_transfer_done();
                             
	}
}
